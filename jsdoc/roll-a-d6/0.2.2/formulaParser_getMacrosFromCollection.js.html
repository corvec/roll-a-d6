<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: formulaParser/getMacrosFromCollection.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: formulaParser/getMacrosFromCollection.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import tokenize, { splitTokenList } from '../formulaTokenizer';
import { clauseHasMislocatedAssignmentOperator } from '../validateFormula';
import convertToRPN from '../rpnConverter';
import { objectMakerReduceHelper } from '../helpers';


/**
 * Transform a formula from the collection into a "main" token list and helper token lists
 * @function convertFormulaToRoll
 *
 * @param {RPNTokenList} tokens
 * @param {string} macroName
 *
 * @returns {CollectionRoll|null}
 */
const convertFormulaToRoll = (tokens, macroName) => {
  const formulaClauses = splitTokenList(tokens);
  if (formulaClauses.some(clauseHasMislocatedAssignmentOperator)) {
    return null;
  }
  const expressions = formulaClauses.filter(clause => clause.length &lt; 2 || clause[1] !== '=');
  if (expressions.length !== 1) {
    return null;
  }
  const macros = formulaClauses.filter(clause => clause.length > 2 &amp;&amp; clause[1] === '=');
  return {
    main: [macroName, '=', ...expressions[0]],
    helpers: macros,
  };
};

/**
 * Convert formulas from the collection(s) into a usable object, already converted to RPN.
 * NOTE: In order to be usable in this way, the collection formula must have exactly 1 "main" expression.
 *       Formulas with 0 or 2+ main expressions are filtered out.
 * @function getMacrosFromCollection
 *
 * @example // returns { roll: { formula: ['1d20', 'bonus', '+'], helpers: { bonus: ['10'] } } }
 * getMacrosFromCollection({ 'roll': '1d20+bonus,bonus=10'})
 *
 * @param {object.&lt;string, string>} collectionFormulasMap - String formulas, basically as entered by the user
 *
 * @returns {Collection}
 */
const getMacrosFromCollection = (collectionFormulasMap) => {
  const rewrittenFormulas = Object.entries(collectionFormulasMap)
    .map(([macroName, formula]) => convertFormulaToRoll(tokenize(formula), macroName))
    .filter(_ => _);
  const macrosAsAnObject = rewrittenFormulas.reduce(
    (accum, { main, helpers }) => ({
      ...accum,
      [main[0]]: {
        formula: convertToRPN(main.slice(2)),
        helpers: helpers
          .map(tokens => [tokens[0], convertToRPN(tokens.slice(2))])
          .reduce(objectMakerReduceHelper, {}),
      }
    }), {});
  return macrosAsAnObject;
};

export default getMacrosFromCollection;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#buildResultRange">buildResultRange</a></li><li><a href="global.html#clauseHasMislocatedAssignmentOperator">clauseHasMislocatedAssignmentOperator</a></li><li><a href="global.html#convertFormulaToRoll">convertFormulaToRoll</a></li><li><a href="global.html#convertToRPN">convertToRPN</a></li><li><a href="global.html#evaluate">evaluate</a></li><li><a href="global.html#evaluateExpression">evaluateExpression</a></li><li><a href="global.html#evaluateFormula">evaluateFormula</a></li><li><a href="global.html#getAllRolls">getAllRolls</a></li><li><a href="global.html#getInitialRollIndex">getInitialRollIndex</a></li><li><a href="global.html#getMacroIndex">getMacroIndex</a></li><li><a href="global.html#getMacroName">getMacroName</a></li><li><a href="global.html#getMacrosFromCollection">getMacrosFromCollection</a></li><li><a href="global.html#getNewVariablesReduceHelper">getNewVariablesReduceHelper</a></li><li><a href="global.html#getPropertyByPath">getPropertyByPath</a></li><li><a href="global.html#getRollMetadata">getRollMetadata</a></li><li><a href="global.html#getRollType">getRollType</a></li><li><a href="global.html#getTargetCollection">getTargetCollection</a></li><li><a href="global.html#getUnassignedVariablesAndUsedMacros">getUnassignedVariablesAndUsedMacros</a></li><li><a href="global.html#isConditional">isConditional</a></li><li><a href="global.html#isExpansionOperator">isExpansionOperator</a></li><li><a href="global.html#isGlobalMacroInstance">isGlobalMacroInstance</a></li><li><a href="global.html#isGrouping">isGrouping</a></li><li><a href="global.html#isMacroInstance">isMacroInstance</a></li><li><a href="global.html#isNumber">isNumber</a></li><li><a href="global.html#isOperator">isOperator</a></li><li><a href="global.html#isRoll">isRoll</a></li><li><a href="global.html#isSideEffectOperator">isSideEffectOperator</a></li><li><a href="global.html#isSideEffectVariable">isSideEffectVariable</a></li><li><a href="global.html#isValidToken">isValidToken</a></li><li><a href="global.html#isValue">isValue</a></li><li><a href="global.html#isVariable">isVariable</a></li><li><a href="global.html#isVariableInstance">isVariableInstance</a></li><li><a href="global.html#objectMakerReduceHelper">objectMakerReduceHelper</a></li><li><a href="global.html#op1Precedes">op1Precedes</a></li><li><a href="global.html#operatorOrder">operatorOrder</a></li><li><a href="global.html#parseAssignments">parseAssignments</a></li><li><a href="global.html#parseTokens">parseTokens</a></li><li><a href="global.html#peek">peek</a></li><li><a href="global.html#rollAD">rollAD</a></li><li><a href="global.html#rollFormula">rollFormula</a></li><li><a href="global.html#splitTokenList">splitTokenList</a></li><li><a href="global.html#stripPrefix">stripPrefix</a></li><li><a href="global.html#stripSuffix">stripSuffix</a></li><li><a href="global.html#tokenize">tokenize</a></li><li><a href="global.html#validateAlternatingTokenType">validateAlternatingTokenType</a></li><li><a href="global.html#validateBrackets">validateBrackets</a></li><li><a href="global.html#validateClause">validateClause</a></li><li><a href="global.html#validateFormula">validateFormula</a></li><li><a href="global.html#validateParentheses">validateParentheses</a></li><li><a href="global.html#variableTargetsCollection">variableTargetsCollection</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sun Mar 15 2020 19:52:36 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
